var e=Object.defineProperty,t=(t,a,s)=>((t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s)(t,"symbol"!=typeof a?a+"":a,s);import{a6 as a,U as s,j as r,L as i,K as c}from"./index--pVY8JWu.js";import{r as o}from"./vendor-BDxjXY-2.js";import{q as d}from"./qrService-DE6BdSVq.js";import{v as n,V as l}from"./validationService-NvwJQYBM.js";import"./charts-C38Ohhsz.js";import"./fallbackService-D-6NybDe.js";const u=new class{constructor(){t(this,"expirationCheckInterval",null),t(this,"EXPIRATION_CHECK_INTERVAL",864e5)}async generateOnApproval(e){var t,s;try{const{validation:r}=await n.getValidation(e);if(!r)return{success:!1,message:"Validation not found"};if(r.status!==l.APPROVED)return{success:!1,message:"Validation is not approved"};if(await d.hasQRCode(r.productId))return{success:!1,message:"QR code already exists for this product"};const i=await d.generateQRCode(r.productId);return await this.createLifecycleEntry({qrCode:i.qrCode,productId:r.productId,validationId:r.id,status:"ACTIVE",activatedAt:(new Date).toISOString(),expirationDate:null==(t=r.lifecycle)?void 0:t.validUntil}),await a.notifyQRCodeGenerated(r.productId,(null==(s=r.product)?void 0:s.name)||"Product"),{success:!0,qrCode:i.qrCode,message:"QR code generated successfully"}}catch(r){return{success:!1,message:r.message||"Failed to generate QR code"}}}async invalidateOnExpiry(e){var t;try{const{validation:s}=await n.getValidation(e);if(!s)return{success:!1,message:"Validation not found"};const r=await this.getLifecycleByValidation(e);return r?(await this.updateQRStatus(r.qrCode,"EXPIRED","Validation expired"),await a.createNotification({title:"QR Code Expired",message:`QR code for ${(null==(t=s.product)?void 0:t.name)||"product"} has expired due to validation expiry`,type:"warning",data:{productId:s.productId,validationId:s.id,qrCode:r.qrCode}}),{success:!0,message:"QR code invalidated successfully"}):{success:!1,message:"QR code lifecycle not found"}}catch(s){return{success:!1,message:s.message||"Failed to invalidate QR code"}}}async regenerateForBatch(e,t){var a;try{const r=(await n.getValidationsByProduct(e)).find((e=>e.status===l.APPROVED));if(!r)return{success:!1,message:"No active validation found for product"};const i=await s.post("/qr/generate-batch",{productId:e,batchNumber:t,validationId:r.id}),c=i.data.qrCodes||[i.data.qrCode];for(const s of c)await this.createLifecycleEntry({qrCode:s,productId:e,validationId:r.id,batchNumber:t,status:"ACTIVE",activatedAt:(new Date).toISOString(),expirationDate:null==(a=r.lifecycle)?void 0:a.validUntil});return{success:!0,qrCodes:c,message:`Generated ${c.length} QR code(s) for batch ${t}`}}catch(r){return{success:!1,message:r.message||"Failed to generate batch QR codes"}}}async updateQRContent(e,t){var a,r,i;try{const c={qrCode:e,content:{validationStatus:t.status||l.PENDING,validationSummary:t.summary,validatedAt:t.validatedAt,expirationDate:null==(a=t.lifecycle)?void 0:a.validUntil,laboratoryName:null==(i=null==(r=t.report)?void 0:r.laboratory)?void 0:i.name}};return await s.put(`/qr/${e}/content`,c),t.status===l.EXPIRED?await this.updateQRStatus(e,"EXPIRED","Validation expired"):t.status===l.SUSPENDED?await this.updateQRStatus(e,"SUSPENDED","Validation suspended"):t.status===l.APPROVED&&await this.updateQRStatus(e,"ACTIVE","Validation reactivated"),{success:!0,message:"QR content updated successfully"}}catch(c){return{success:!1,message:c.message||"Failed to update QR content"}}}scheduleExpirationCheck(){this.expirationCheckInterval&&clearInterval(this.expirationCheckInterval),this.checkExpiredValidations(),this.expirationCheckInterval=setInterval((()=>{this.checkExpiredValidations()}),this.EXPIRATION_CHECK_INTERVAL)}stopExpirationCheck(){this.expirationCheckInterval&&(clearInterval(this.expirationCheckInterval),this.expirationCheckInterval=null)}async checkExpiredValidations(){try{const e=await this.getActiveQRCodesWithExpiration();let t=0;const s=new Date;for(const r of e)if(r.expirationDate){const e=new Date(r.expirationDate);if(e<=s)await this.updateQRStatus(r.qrCode,"EXPIRED","Scheduled expiration check"),t++,await a.createNotification({title:"QR Code Expired",message:`QR code ${r.qrCode} has expired`,type:"warning",data:{qrCode:r.qrCode,productId:r.productId,expiredAt:s.toISOString()}});else{const t=Math.ceil((e.getTime()-s.getTime())/864e5);t<=30&&t>0&&await a.createNotification({title:"QR Code Expiring Soon",message:`QR code ${r.qrCode} will expire in ${t} days`,type:"warning",data:{qrCode:r.qrCode,productId:r.productId,daysUntilExpiry:t,expirationDate:r.expirationDate}})}}await this.logExpirationCheck({scheduledFor:s.toISOString(),status:"COMPLETED",productsToCheck:e.length,productsExpired:t})}catch(e){await this.logExpirationCheck({scheduledFor:(new Date).toISOString(),status:"FAILED",productsToCheck:0,productsExpired:0})}}async getQRStatus(e){try{const a=await this.getLifecycleByQRCode(e);if(!a)return{status:"PENDING",lifecycle:void 0};let r,i;if(a.validationId)try{const{validation:e}=await n.getValidation(a.validationId);r=e}catch(t){}try{i=(await s.get(`/products/${a.productId}`)).data.product}catch(t){}return{status:a.status,lifecycle:a,validation:r,product:i}}catch(t){return{status:"PENDING"}}}async regenerateOnRevalidation(e,t){try{const s=await this.getQRCodesByProduct(e);for(const e of s)"ACTIVE"===e.status&&await this.updateQRStatus(e.qrCode,"REVOKED","Revalidation initiated");const r=await this.generateOnApproval(t);return r.success&&await a.createNotification({title:"QR Code Regenerated",message:"New QR code generated due to product revalidation",type:"success",data:{productId:e,validationId:t,qrCode:r.qrCode}}),r}catch(s){return{success:!1,message:s.message||"Failed to regenerate QR code"}}}async suspendQRCode(e,t){try{return await this.updateQRStatus(e,"SUSPENDED",t),{success:!0,message:"QR code suspended successfully"}}catch(a){return{success:!1,message:a.message||"Failed to suspend QR code"}}}async reactivateQRCode(e,t){try{const a=await this.getLifecycleByQRCode(e);return a?"SUSPENDED"!==a.status?{success:!1,message:"QR code is not suspended"}:(await this.updateQRStatus(e,"ACTIVE",t),{success:!0,message:"QR code reactivated successfully"}):{success:!1,message:"QR code not found"}}catch(a){return{success:!1,message:a.message||"Failed to reactivate QR code"}}}async revokeQRCode(e,t){try{return await this.updateQRStatus(e,"REVOKED",t),{success:!0,message:"QR code revoked permanently"}}catch(a){return{success:!1,message:a.message||"Failed to revoke QR code"}}}async generateBatchQRCodes(e){try{const t=[];for(let a=0;a<e.quantity;a++){const r=(await s.post("/qr/generate",{productId:e.productId,batchNumber:e.batchNumber,validationId:e.validationId,serialNumber:`${e.batchNumber}-${String(a+1).padStart(6,"0")}`})).data.qrCode;t.push(r),await this.createLifecycleEntry({qrCode:r,productId:e.productId,validationId:e.validationId,batchNumber:e.batchNumber,status:"ACTIVE",activatedAt:(new Date).toISOString(),expirationDate:e.expirationDate})}return{success:!0,qrCodes:t,message:`Generated ${t.length} QR codes for batch ${e.batchNumber}`}}catch(t){return{success:!1,message:t.message||"Failed to generate batch QR codes"}}}async createLifecycleEntry(e){try{await s.post("/qr/lifecycle",{...e,generatedAt:(new Date).toISOString(),lastStatusChange:(new Date).toISOString(),statusHistory:[{previousStatus:"PENDING",newStatus:e.status||"PENDING",changedAt:(new Date).toISOString(),reason:"Initial creation"}]})}catch(t){}}async updateQRStatus(e,t,a){try{const r=await this.getLifecycleByQRCode(e);if(!r)throw new Error("QR lifecycle not found");const i={previousStatus:r.status,newStatus:t,changedAt:(new Date).toISOString(),reason:a};await s.put(`/qr/lifecycle/${e}`,{status:t,lastStatusChange:i.changedAt,statusHistory:[...r.statusHistory||[],i],..."EXPIRED"===t&&{expiredAt:i.changedAt},..."SUSPENDED"===t&&{suspendedAt:i.changedAt},..."REVOKED"===t&&{revokedAt:i.changedAt}})}catch(r){throw r}}async getLifecycleByQRCode(e){try{return(await s.get(`/qr/lifecycle/${e}`)).data.lifecycle}catch(t){return null}}async getLifecycleByValidation(e){try{return(await s.get(`/qr/lifecycle/validation/${e}`)).data.lifecycle}catch(t){return null}}async getQRCodesByProduct(e){try{return(await s.get(`/qr/lifecycle/product/${e}`)).data.lifecycles||[]}catch(t){return[]}}async getActiveQRCodesWithExpiration(){try{return(await s.get("/qr/lifecycle/active-with-expiration")).data.lifecycles||[]}catch(e){return[]}}async logExpirationCheck(e){try{await s.post("/qr/lifecycle/expiration-check-log",e)}catch(t){}}};function g(){const[e,t]=o.useState(!1),[a,s]=o.useState([]),[d,l]=o.useState(""),[g,m]=o.useState([]),[p,h]=o.useState(""),[y,x]=o.useState(null);o.useEffect((()=>{v()}),[]);const v=async()=>{try{const e=await n.getValidations({limit:50});m(e.data)}catch(e){}},f=e=>{s((t=>[...t,e]))},b=async()=>{if(!p)return void c.error("No QR code available. Generate one first.");t(!0);const e="Get QR Status";try{const t=await u.getQRStatus(p);x(t),f({testName:e,status:"success",message:`QR Status: ${t.status}`,data:t}),c.success("QR status retrieved successfully!")}catch(a){f({testName:e,status:"error",message:a.message||"Failed to get QR status"}),c.error("Failed to get QR status")}finally{t(!1)}};return r.jsxs("div",{className:"container mx-auto px-4 py-8",children:[r.jsx("h1",{className:"text-2xl font-bold mb-6",children:"QR Code Lifecycle Management Test"}),r.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[r.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Test Configuration"}),r.jsxs("div",{className:"mb-4",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Validation"}),r.jsxs("select",{value:d,onChange:e=>l(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",children:[r.jsx("option",{value:"",children:"Select a validation..."}),g.map((e=>{var t;return r.jsxs("option",{value:e.id,children:[(null==(t=e.product)?void 0:t.name)||"Unknown Product"," - Status: ",e.status," - ID: ",e.id]},e.id)}))]})]}),p&&r.jsxs("div",{className:"mb-4 p-4 bg-gray-50 rounded-lg",children:[r.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Current Test QR Code:"}),r.jsx("p",{className:"font-mono text-sm mt-1",children:p})]}),y&&r.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-lg",children:[r.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"QR Code Status:"}),r.jsxs("div",{className:"space-y-1 text-sm",children:[r.jsxs("p",{children:[r.jsx("span",{className:"font-medium",children:"Status:"})," ",y.status]}),y.lifecycle&&r.jsxs(r.Fragment,{children:[r.jsxs("p",{children:[r.jsx("span",{className:"font-medium",children:"Generated At:"})," ",new Date(y.lifecycle.generatedAt).toLocaleString()]}),y.lifecycle.expirationDate&&r.jsxs("p",{children:[r.jsx("span",{className:"font-medium",children:"Expires At:"})," ",new Date(y.lifecycle.expirationDate).toLocaleString()]})]}),y.product&&r.jsxs("p",{children:[r.jsx("span",{className:"font-medium",children:"Product:"})," ",y.product.name]})]})]})]}),r.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[r.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Test Actions"}),r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[r.jsx("button",{onClick:async()=>{if(!d)return void c.error("Please select a validation first");t(!0);const e="Generate QR on Approval";try{const t=await u.generateOnApproval(d);t.success&&t.qrCode?(h(t.qrCode),f({testName:e,status:"success",message:t.message,data:{qrCode:t.qrCode}}),c.success("QR Code generated successfully!")):(f({testName:e,status:"error",message:t.message}),c.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to generate QR code"}),c.error("Failed to generate QR code")}finally{t(!1)}},disabled:e||!d,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Generate QR on Approval"}),r.jsx("button",{onClick:b,disabled:e||!p,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Check QR Status"}),r.jsx("button",{onClick:async()=>{if(!p)return void c.error("No QR code available. Generate one first.");t(!0);const e="Suspend QR Code";try{const t=await u.suspendQRCode(p,"Testing suspension functionality");t.success?(f({testName:e,status:"success",message:t.message}),c.success("QR Code suspended successfully!"),await b()):(f({testName:e,status:"error",message:t.message}),c.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to suspend QR code"}),c.error("Failed to suspend QR code")}finally{t(!1)}},disabled:e||!p,className:"px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Suspend QR Code"}),r.jsx("button",{onClick:async()=>{if(!p)return void c.error("No QR code available. Generate one first.");t(!0);const e="Reactivate QR Code";try{const t=await u.reactivateQRCode(p,"Testing reactivation functionality");t.success?(f({testName:e,status:"success",message:t.message}),c.success("QR Code reactivated successfully!"),await b()):(f({testName:e,status:"error",message:t.message}),c.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to reactivate QR code"}),c.error("Failed to reactivate QR code")}finally{t(!1)}},disabled:e||!p,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Reactivate QR Code"}),r.jsx("button",{onClick:async()=>{if(!d)return void c.error("Please select a validation first");t(!0);const e="Batch QR Generation";try{const{validation:t}=await n.getValidation(d),a=await u.generateBatchQRCodes({productId:t.productId,batchNumber:"TEST-BATCH-001",quantity:5,validationId:d,expirationDate:new Date(Date.now()+7776e6).toISOString()});a.success&&a.qrCodes?(f({testName:e,status:"success",message:a.message,data:{qrCodes:a.qrCodes}}),c.success(`Generated ${a.qrCodes.length} QR codes!`),h(a.qrCodes[0])):(f({testName:e,status:"error",message:a.message}),c.error(a.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to generate batch QR codes"}),c.error("Failed to generate batch QR codes")}finally{t(!1)}},disabled:e||!d,className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Generate Batch QRs"}),r.jsx("button",{onClick:async()=>{if(!p)return void c.error("No QR code available. Generate one first.");t(!0);const e="Update QR Content";try{const t=await u.updateQRContent(p,{status:"APPROVED",summary:"Updated validation summary for testing",validatedAt:(new Date).toISOString(),lifecycle:{validUntil:new Date(Date.now()+15552e6).toISOString()}});t.success?(f({testName:e,status:"success",message:t.message}),c.success("QR content updated successfully!")):(f({testName:e,status:"error",message:t.message}),c.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to update QR content"}),c.error("Failed to update QR content")}finally{t(!1)}},disabled:e||!p,className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Update QR Content"}),r.jsx("button",{onClick:async()=>{if(!d)return void c.error("Please select a validation first");t(!0);const e="Invalidate QR on Expiry";try{const t=await u.invalidateOnExpiry(d);t.success?(f({testName:e,status:"success",message:t.message}),c.success("QR Code invalidated successfully!"),p&&await b()):(f({testName:e,status:"error",message:t.message}),c.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to invalidate QR code"}),c.error("Failed to invalidate QR code")}finally{t(!1)}},disabled:e||!d,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Invalidate on Expiry"}),r.jsx("button",{onClick:()=>{s([]),h(""),x(null)},disabled:e,className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Clear Results"})]})]}),r.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[r.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Test Results"}),e&&r.jsx("div",{className:"flex justify-center py-8",children:r.jsx(i,{})}),0===a.length&&!e&&r.jsx("p",{className:"text-gray-500 text-center py-8",children:"No test results yet. Run a test to see results."}),r.jsx("div",{className:"space-y-4",children:a.map(((e,t)=>r.jsx("div",{className:"p-4 rounded-lg border "+("success"===e.status?"bg-green-50 border-green-300":"error"===e.status?"bg-red-50 border-red-300":"bg-gray-50 border-gray-300"),children:r.jsxs("div",{className:"flex items-start justify-between",children:[r.jsxs("div",{className:"flex-1",children:[r.jsx("h3",{className:"font-medium text-gray-900",children:e.testName}),r.jsx("p",{className:"text-sm text-gray-600 mt-1",children:e.message}),e.data&&r.jsxs("details",{className:"mt-2",children:[r.jsx("summary",{className:"cursor-pointer text-sm text-blue-600 hover:text-blue-800",children:"View Details"}),r.jsx("pre",{className:"mt-2 text-xs bg-gray-100 p-2 rounded overflow-x-auto",children:JSON.stringify(e.data,null,2)})]})]}),r.jsx("span",{className:"ml-4 text-sm font-medium "+("success"===e.status?"text-green-600":"error"===e.status?"text-red-600":"text-gray-600"),children:e.status.toUpperCase()})]})},t)))})]}),r.jsxs("div",{className:"mt-6 bg-blue-50 rounded-lg p-6",children:[r.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"Testing Instructions"}),r.jsxs("ol",{className:"list-decimal list-inside space-y-1 text-sm text-blue-800",children:[r.jsx("li",{children:"Select a validation from the dropdown (preferably one with APPROVED status)"}),r.jsx("li",{children:'Click "Generate QR on Approval" to create a QR code'}),r.jsx("li",{children:'Use "Check QR Status" to verify the current status'}),r.jsx("li",{children:"Test lifecycle operations: Suspend, Reactivate, Update Content"}),r.jsx("li",{children:'Try "Generate Batch QRs" for multiple QR codes'}),r.jsx("li",{children:'Test "Invalidate on Expiry" to simulate expiration'})]})]})]})}"undefined"!=typeof window&&(u.scheduleExpirationCheck(),window.addEventListener("beforeunload",(()=>{u.stopExpirationCheck()})));export{g as QRLifecycleTest};
