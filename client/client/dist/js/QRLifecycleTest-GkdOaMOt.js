var e=Object.defineProperty,t=(t,a,s)=>((t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s)(t,"symbol"!=typeof a?a+"":a,s);import{r as a,j as s}from"./react-core-XCdXHkeW.js";import{n as r,b as i,L as c,t as n}from"./index-D7IercYq.js";import{q as d}from"./qrService-BwD7nkbO.js";import{v as o,V as l}from"./validationService-Ds-ci427.js";import"./vendor-BcMaAnXF.js";import"./state-QrSTFgAv.js";import"./react-dom-BslC4xag.js";import"./react-router-G9IXNjIc.js";import"./utils-BtzqxagS.js";import"./forms-Bk6aQ3xQ.js";import"./fallbackService-QR578FZI.js";const u=new class{constructor(){t(this,"expirationCheckInterval",null),t(this,"EXPIRATION_CHECK_INTERVAL",864e5)}async generateOnApproval(e){var t,a;try{const{validation:s}=await o.getValidation(e);if(!s)return{success:!1,message:"Validation not found"};if(s.status!==l.APPROVED)return{success:!1,message:"Validation is not approved"};if(await d.hasQRCode(s.productId))return{success:!1,message:"QR code already exists for this product"};const i=await d.generateQRCode(s.productId);return await this.createLifecycleEntry({qrCode:i.qrCode,productId:s.productId,validationId:s.id,status:"ACTIVE",activatedAt:(new Date).toISOString(),expirationDate:null==(t=s.lifecycle)?void 0:t.validUntil}),await r.notifyQRCodeGenerated(s.productId,(null==(a=s.product)?void 0:a.name)||"Product"),{success:!0,qrCode:i.qrCode,message:"QR code generated successfully"}}catch(s){return{success:!1,message:s.message||"Failed to generate QR code"}}}async invalidateOnExpiry(e){var t;try{const{validation:a}=await o.getValidation(e);if(!a)return{success:!1,message:"Validation not found"};const s=await this.getLifecycleByValidation(e);return s?(await this.updateQRStatus(s.qrCode,"EXPIRED","Validation expired"),await r.createNotification({title:"QR Code Expired",message:`QR code for ${(null==(t=a.product)?void 0:t.name)||"product"} has expired due to validation expiry`,type:"warning",data:{productId:a.productId,validationId:a.id,qrCode:s.qrCode}}),{success:!0,message:"QR code invalidated successfully"}):{success:!1,message:"QR code lifecycle not found"}}catch(a){return{success:!1,message:a.message||"Failed to invalidate QR code"}}}async regenerateForBatch(e,t){var a;try{const s=(await o.getValidationsByProduct(e)).find((e=>e.status===l.APPROVED));if(!s)return{success:!1,message:"No active validation found for product"};const r=await i.post("/qr/generate-batch",{productId:e,batchNumber:t,validationId:s.id}),c=r.data.qrCodes||[r.data.qrCode];for(const i of c)await this.createLifecycleEntry({qrCode:i,productId:e,validationId:s.id,batchNumber:t,status:"ACTIVE",activatedAt:(new Date).toISOString(),expirationDate:null==(a=s.lifecycle)?void 0:a.validUntil});return{success:!0,qrCodes:c,message:`Generated ${c.length} QR code(s) for batch ${t}`}}catch(s){return{success:!1,message:s.message||"Failed to generate batch QR codes"}}}async updateQRContent(e,t){var a,s,r;try{const c={qrCode:e,content:{validationStatus:t.status||l.PENDING,validationSummary:t.summary,validatedAt:t.validatedAt,expirationDate:null==(a=t.lifecycle)?void 0:a.validUntil,laboratoryName:null==(r=null==(s=t.report)?void 0:s.laboratory)?void 0:r.name}};return await i.put(`/qr/${e}/content`,c),t.status===l.EXPIRED?await this.updateQRStatus(e,"EXPIRED","Validation expired"):t.status===l.SUSPENDED?await this.updateQRStatus(e,"SUSPENDED","Validation suspended"):t.status===l.APPROVED&&await this.updateQRStatus(e,"ACTIVE","Validation reactivated"),{success:!0,message:"QR content updated successfully"}}catch(c){return{success:!1,message:c.message||"Failed to update QR content"}}}scheduleExpirationCheck(){this.expirationCheckInterval&&clearInterval(this.expirationCheckInterval),this.checkExpiredValidations(),this.expirationCheckInterval=setInterval((()=>{this.checkExpiredValidations()}),this.EXPIRATION_CHECK_INTERVAL)}stopExpirationCheck(){this.expirationCheckInterval&&(clearInterval(this.expirationCheckInterval),this.expirationCheckInterval=null)}async checkExpiredValidations(){try{const e=await this.getActiveQRCodesWithExpiration();let t=0;const a=new Date;for(const s of e)if(s.expirationDate){const e=new Date(s.expirationDate);if(e<=a)await this.updateQRStatus(s.qrCode,"EXPIRED","Scheduled expiration check"),t++,await r.createNotification({title:"QR Code Expired",message:`QR code ${s.qrCode} has expired`,type:"warning",data:{qrCode:s.qrCode,productId:s.productId,expiredAt:a.toISOString()}});else{const t=Math.ceil((e.getTime()-a.getTime())/864e5);t<=30&&t>0&&await r.createNotification({title:"QR Code Expiring Soon",message:`QR code ${s.qrCode} will expire in ${t} days`,type:"warning",data:{qrCode:s.qrCode,productId:s.productId,daysUntilExpiry:t,expirationDate:s.expirationDate}})}}await this.logExpirationCheck({scheduledFor:a.toISOString(),status:"COMPLETED",productsToCheck:e.length,productsExpired:t})}catch(e){await this.logExpirationCheck({scheduledFor:(new Date).toISOString(),status:"FAILED",productsToCheck:0,productsExpired:0})}}async getQRStatus(e){try{const a=await this.getLifecycleByQRCode(e);if(!a)return{status:"PENDING",lifecycle:void 0};let s,r;if(a.validationId)try{const{validation:e}=await o.getValidation(a.validationId);s=e}catch(t){}try{r=(await i.get(`/products/${a.productId}`)).data.product}catch(t){}return{status:a.status,lifecycle:a,validation:s,product:r}}catch(t){return{status:"PENDING"}}}async regenerateOnRevalidation(e,t){try{const a=await this.getQRCodesByProduct(e);for(const e of a)"ACTIVE"===e.status&&await this.updateQRStatus(e.qrCode,"REVOKED","Revalidation initiated");const s=await this.generateOnApproval(t);return s.success&&await r.createNotification({title:"QR Code Regenerated",message:"New QR code generated due to product revalidation",type:"success",data:{productId:e,validationId:t,qrCode:s.qrCode}}),s}catch(a){return{success:!1,message:a.message||"Failed to regenerate QR code"}}}async suspendQRCode(e,t){try{return await this.updateQRStatus(e,"SUSPENDED",t),{success:!0,message:"QR code suspended successfully"}}catch(a){return{success:!1,message:a.message||"Failed to suspend QR code"}}}async reactivateQRCode(e,t){try{const a=await this.getLifecycleByQRCode(e);return a?"SUSPENDED"!==a.status?{success:!1,message:"QR code is not suspended"}:(await this.updateQRStatus(e,"ACTIVE",t),{success:!0,message:"QR code reactivated successfully"}):{success:!1,message:"QR code not found"}}catch(a){return{success:!1,message:a.message||"Failed to reactivate QR code"}}}async revokeQRCode(e,t){try{return await this.updateQRStatus(e,"REVOKED",t),{success:!0,message:"QR code revoked permanently"}}catch(a){return{success:!1,message:a.message||"Failed to revoke QR code"}}}async generateBatchQRCodes(e){try{const t=[];for(let a=0;a<e.quantity;a++){const s=(await i.post("/qr/generate",{productId:e.productId,batchNumber:e.batchNumber,validationId:e.validationId,serialNumber:`${e.batchNumber}-${String(a+1).padStart(6,"0")}`})).data.qrCode;t.push(s),await this.createLifecycleEntry({qrCode:s,productId:e.productId,validationId:e.validationId,batchNumber:e.batchNumber,status:"ACTIVE",activatedAt:(new Date).toISOString(),expirationDate:e.expirationDate})}return{success:!0,qrCodes:t,message:`Generated ${t.length} QR codes for batch ${e.batchNumber}`}}catch(t){return{success:!1,message:t.message||"Failed to generate batch QR codes"}}}async createLifecycleEntry(e){try{await i.post("/qr/lifecycle",{...e,generatedAt:(new Date).toISOString(),lastStatusChange:(new Date).toISOString(),statusHistory:[{previousStatus:"PENDING",newStatus:e.status||"PENDING",changedAt:(new Date).toISOString(),reason:"Initial creation"}]})}catch(t){}}async updateQRStatus(e,t,a){try{const s=await this.getLifecycleByQRCode(e);if(!s)throw new Error("QR lifecycle not found");const r={previousStatus:s.status,newStatus:t,changedAt:(new Date).toISOString(),reason:a};await i.put(`/qr/lifecycle/${e}`,{status:t,lastStatusChange:r.changedAt,statusHistory:[...s.statusHistory||[],r],..."EXPIRED"===t&&{expiredAt:r.changedAt},..."SUSPENDED"===t&&{suspendedAt:r.changedAt},..."REVOKED"===t&&{revokedAt:r.changedAt}})}catch(s){throw s}}async getLifecycleByQRCode(e){try{return(await i.get(`/qr/lifecycle/${e}`)).data.lifecycle}catch(t){return null}}async getLifecycleByValidation(e){try{return(await i.get(`/qr/lifecycle/validation/${e}`)).data.lifecycle}catch(t){return null}}async getQRCodesByProduct(e){try{return(await i.get(`/qr/lifecycle/product/${e}`)).data.lifecycles||[]}catch(t){return[]}}async getActiveQRCodesWithExpiration(){try{return(await i.get("/qr/lifecycle/active-with-expiration")).data.lifecycles||[]}catch(e){return[]}}async logExpirationCheck(e){try{await i.post("/qr/lifecycle/expiration-check-log",e)}catch(t){}}};function m(){const[e,t]=a.useState(!1),[r,i]=a.useState([]),[d,l]=a.useState(""),[m,h]=a.useState([]),[g,p]=a.useState(""),[y,b]=a.useState(null);a.useEffect((()=>{v()}),[]);const v=async()=>{try{const e=await o.getValidations({limit:50});h(e.data)}catch(e){}},f=e=>{i((t=>[...t,e]))},w=async()=>{if(!g)return void n.error("No QR code available. Generate one first.");t(!0);const e="Get QR Status";try{const t=await u.getQRStatus(g);b(t),f({testName:e,status:"success",message:`QR Status: ${t.status}`,data:t}),n.success("QR status retrieved successfully!")}catch(a){f({testName:e,status:"error",message:a.message||"Failed to get QR status"}),n.error("Failed to get QR status")}finally{t(!1)}};return s.jsxs("div",{className:"container mx-auto px-4 py-8",children:[s.jsx("h1",{className:"text-2xl font-bold mb-6",children:"QR Code Lifecycle Management Test"}),s.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Test Configuration"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Validation"}),s.jsxs("select",{value:d,onChange:e=>l(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",children:[s.jsx("option",{value:"",children:"Select a validation..."}),m.map((e=>{var t;return s.jsxs("option",{value:e.id,children:[(null==(t=e.product)?void 0:t.name)||"Unknown Product"," - Status: ",e.status," - ID: ",e.id]},e.id)}))]})]}),g&&s.jsxs("div",{className:"mb-4 p-4 bg-gray-50 rounded-lg",children:[s.jsx("p",{className:"text-sm font-medium text-gray-700",children:"Current Test QR Code:"}),s.jsx("p",{className:"font-mono text-sm mt-1",children:g})]}),y&&s.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-lg",children:[s.jsx("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"QR Code Status:"}),s.jsxs("div",{className:"space-y-1 text-sm",children:[s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"Status:"})," ",y.status]}),y.lifecycle&&s.jsxs(s.Fragment,{children:[s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"Generated At:"})," ",new Date(y.lifecycle.generatedAt).toLocaleString()]}),y.lifecycle.expirationDate&&s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"Expires At:"})," ",new Date(y.lifecycle.expirationDate).toLocaleString()]})]}),y.product&&s.jsxs("p",{children:[s.jsx("span",{className:"font-medium",children:"Product:"})," ",y.product.name]})]})]})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Test Actions"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[s.jsx("button",{onClick:async()=>{if(!d)return void n.error("Please select a validation first");t(!0);const e="Generate QR on Approval";try{const t=await u.generateOnApproval(d);t.success&&t.qrCode?(p(t.qrCode),f({testName:e,status:"success",message:t.message,data:{qrCode:t.qrCode}}),n.success("QR Code generated successfully!")):(f({testName:e,status:"error",message:t.message}),n.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to generate QR code"}),n.error("Failed to generate QR code")}finally{t(!1)}},disabled:e||!d,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Generate QR on Approval"}),s.jsx("button",{onClick:w,disabled:e||!g,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Check QR Status"}),s.jsx("button",{onClick:async()=>{if(!g)return void n.error("No QR code available. Generate one first.");t(!0);const e="Suspend QR Code";try{const t=await u.suspendQRCode(g,"Testing suspension functionality");t.success?(f({testName:e,status:"success",message:t.message}),n.success("QR Code suspended successfully!"),await w()):(f({testName:e,status:"error",message:t.message}),n.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to suspend QR code"}),n.error("Failed to suspend QR code")}finally{t(!1)}},disabled:e||!g,className:"px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Suspend QR Code"}),s.jsx("button",{onClick:async()=>{if(!g)return void n.error("No QR code available. Generate one first.");t(!0);const e="Reactivate QR Code";try{const t=await u.reactivateQRCode(g,"Testing reactivation functionality");t.success?(f({testName:e,status:"success",message:t.message}),n.success("QR Code reactivated successfully!"),await w()):(f({testName:e,status:"error",message:t.message}),n.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to reactivate QR code"}),n.error("Failed to reactivate QR code")}finally{t(!1)}},disabled:e||!g,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Reactivate QR Code"}),s.jsx("button",{onClick:async()=>{if(!d)return void n.error("Please select a validation first");t(!0);const e="Batch QR Generation";try{const{validation:t}=await o.getValidation(d),a=await u.generateBatchQRCodes({productId:t.productId,batchNumber:"TEST-BATCH-001",quantity:5,validationId:d,expirationDate:new Date(Date.now()+7776e6).toISOString()});a.success&&a.qrCodes?(f({testName:e,status:"success",message:a.message,data:{qrCodes:a.qrCodes}}),n.success(`Generated ${a.qrCodes.length} QR codes!`),p(a.qrCodes[0])):(f({testName:e,status:"error",message:a.message}),n.error(a.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to generate batch QR codes"}),n.error("Failed to generate batch QR codes")}finally{t(!1)}},disabled:e||!d,className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Generate Batch QRs"}),s.jsx("button",{onClick:async()=>{if(!g)return void n.error("No QR code available. Generate one first.");t(!0);const e="Update QR Content";try{const t=await u.updateQRContent(g,{status:"APPROVED",summary:"Updated validation summary for testing",validatedAt:(new Date).toISOString(),lifecycle:{validUntil:new Date(Date.now()+15552e6).toISOString()}});t.success?(f({testName:e,status:"success",message:t.message}),n.success("QR content updated successfully!")):(f({testName:e,status:"error",message:t.message}),n.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to update QR content"}),n.error("Failed to update QR content")}finally{t(!1)}},disabled:e||!g,className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Update QR Content"}),s.jsx("button",{onClick:async()=>{if(!d)return void n.error("Please select a validation first");t(!0);const e="Invalidate QR on Expiry";try{const t=await u.invalidateOnExpiry(d);t.success?(f({testName:e,status:"success",message:t.message}),n.success("QR Code invalidated successfully!"),g&&await w()):(f({testName:e,status:"error",message:t.message}),n.error(t.message))}catch(a){f({testName:e,status:"error",message:a.message||"Failed to invalidate QR code"}),n.error("Failed to invalidate QR code")}finally{t(!1)}},disabled:e||!d,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Invalidate on Expiry"}),s.jsx("button",{onClick:()=>{i([]),p(""),b(null)},disabled:e,className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Clear Results"})]})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Test Results"}),e&&s.jsx("div",{className:"flex justify-center py-8",children:s.jsx(c,{})}),0===r.length&&!e&&s.jsx("p",{className:"text-gray-500 text-center py-8",children:"No test results yet. Run a test to see results."}),s.jsx("div",{className:"space-y-4",children:r.map(((e,t)=>s.jsx("div",{className:"p-4 rounded-lg border "+("success"===e.status?"bg-green-50 border-green-300":"error"===e.status?"bg-red-50 border-red-300":"bg-gray-50 border-gray-300"),children:s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"font-medium text-gray-900",children:e.testName}),s.jsx("p",{className:"text-sm text-gray-600 mt-1",children:e.message}),e.data&&s.jsxs("details",{className:"mt-2",children:[s.jsx("summary",{className:"cursor-pointer text-sm text-blue-600 hover:text-blue-800",children:"View Details"}),s.jsx("pre",{className:"mt-2 text-xs bg-gray-100 p-2 rounded overflow-x-auto",children:JSON.stringify(e.data,null,2)})]})]}),s.jsx("span",{className:"ml-4 text-sm font-medium "+("success"===e.status?"text-green-600":"error"===e.status?"text-red-600":"text-gray-600"),children:e.status.toUpperCase()})]})},t)))})]}),s.jsxs("div",{className:"mt-6 bg-blue-50 rounded-lg p-6",children:[s.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:"Testing Instructions"}),s.jsxs("ol",{className:"list-decimal list-inside space-y-1 text-sm text-blue-800",children:[s.jsx("li",{children:"Select a validation from the dropdown (preferably one with APPROVED status)"}),s.jsx("li",{children:'Click "Generate QR on Approval" to create a QR code'}),s.jsx("li",{children:'Use "Check QR Status" to verify the current status'}),s.jsx("li",{children:"Test lifecycle operations: Suspend, Reactivate, Update Content"}),s.jsx("li",{children:'Try "Generate Batch QRs" for multiple QR codes'}),s.jsx("li",{children:'Test "Invalidate on Expiry" to simulate expiration'})]})]})]})}"undefined"!=typeof window&&(u.scheduleExpirationCheck(),window.addEventListener("beforeunload",(()=>{u.stopExpirationCheck()})));export{m as QRLifecycleTest};
